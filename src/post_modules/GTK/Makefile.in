# This line is needed on some machines.
@make_variables@
VPATH=@srcdir@:@srcdir@/../..:../..:.
MODNAME=GTK
DEST=@prefix@/lib/pike/modules/
OBJS=dummy.o
MODULE_LDFLAGS=@LDFLAGS@ @LIBS@ @PGTK_LIBS@ @LIBGLADE_LIBS@
MODULE_CFLAGS=@PGTK_CFLAGS@ @LIBGLADE_CFLAGS@
CONFIG_HEADERS=config.h

# OK.. This is somewhat confusing
# 
# WITH_GTK == 1
#   override -> sources1 -> [SET OBJS] -> all
#
# WITH_GTK == 0
#   override -> sources0 -> all
#

MYRUNPIKE=../../pike -DNOT_INSTALLED -m../../master.pike


override:  sources@WITH_GTK@
	@:

@dynamic_module_makefile@

sources1:
	$(RUNPIKE) $(SRCDIR)/make_sources.pike $(SRCDIR)/source
	$(MAKE) CFLAGS="`echo $(CFLAGS) | sed -e 's/-g//g'`" "SOURCES=`cat sources`" doit

always_build_files_to_compile: $(SOURCES)
	$(RUNPIKE) $(SRCDIR)/build_pgtk.pike $(SRCDIR)

doit: always_build_files_to_compile
	$(MAKE) CFLAGS="`echo $(CFLAGS) | sed -e 's/-g//g'`" "OBJS=`cat files_to_compile`" all

sources0:
	echo Pike-GTK disabled.
	$(MAKE) all

docs: docs@WITH_GTK@
	@:

wmml: wmml@WITH_GTK@
	@:

docs1:
	-@mkdir docs
	-$(MYRUNPIKE) $(SRCDIR)/dump_cursors.pike docs/cursor_
	$(MYRUNPIKE) $(SRCDIR)/build_pgtk.pike $(SRCDIR) docs


docs0:
	echo Pike-GTK disabled.

wmml1:
	-@mkdir wmml
	-@mkdir wmml/gtkimg
	-$(MYRUNPIKE) $(SRCDIR)/dump_cursors.pike wmml/gtkimg/cursor_
	$(MYRUNPIKE) $(SRCDIR)/build_pgtk.pike $(SRCDIR) --wmml


wmml0:
	echo Pike-GTK disabled.

#
# Many machines have problems compiling this file with full optimization.
#

pgtk.o: pgtk.c
	@echo "Compiling $< with less optimization" ;\
	if $(CC) $(NOOPT_CFLAGS) -O -c $< -o $@ ; then : ;\
	else \
	  echo "WARNING: Compiler failure! Trying without optimization!" >&2;\
	  echo "echo $(CC) $(NOOPT_CFLAGS) -c $< -o $@" >&2;\
	  NO_ULIMIT=yes $(CC) $(NOOPT_CFLAGS) -c $< -o $@ ;\
	fi
