#
# $Id: dynamic_module_makefile.in,v 1.105 2003/05/15 14:04:51 grubba Exp $
#

LIBGCC=@LIBGCC@
LC_REQ=@LC_REQ@

LINKAGE_CPPFLAGS=
LINKAGE_CFLAGS=@CCSHARED@

MODULE_PROGRAM=.___$(MODNAME)
MODULE_TARGET=$(TMP_MODULE_BASE)/$(MODDIR)___$(MODNAME).so


@common_module_makefile@

linker_options: Makefile
	@if test "x$(LINKER_OPTIONS)" != x ; then \
	  echo "LINKER_OPTIONS+=$(LINKER_OPTIONS)" ; \
	else : ; fi ; \
	echo "$(LINKER_OPTIONS)" >linker_options

modlist_headers: Makefile
	@echo "" >modlist_headers

modlist_segment: Makefile
	@echo "" >modlist_segment

# Can't depend on $(SRCDIR)/$(CONFIG_HEADERS).in since
# $(CONFIG_HEADERS) isn't always used.
Makefile: $(MODULE_BASE)/dynamic_module_makefile $(SRCDIR)/Makefile.in $(SRCDIR)/dependencies make_variables config.status
	CONFIG_FILES=Makefile CONFIG_HEADERS="$(CONFIG_HEADERS)" ./config.status
	touch remake
	@echo "Run make again" >&2
	@exit 1

$(MODULE_TARGET): module.so
	$(TMP_BINDIR)/install_module module.so $(MODULE_TARGET)

module.so: $(OBJS)  $(MODULE_ARCHIVES)
	@echo "Linking $(MODNAME)" ;\
	if $(TMP_BINDIR)/smartlink "$(LDSHARED)" $(LDFLAGS) -o module.@SO@ \
	    $(OBJS) $(MODULE_ARCHIVES) $(MODULE_LDFLAGS) \
	    $(LIBGCC) $(LC_REQ) $(LIBGCC) ; then \
	  if test @SO@ != so ; then mv module.@SO@ module.so ; else :; fi ;\
	else \
	  echo "Linking failed:" >&2; \
	  echo $(TMP_BINDIR)/smartlink "$(LDSHARED)" $(LDFLAGS) -o module.@SO@ $(OBJS) $(MODULE_ARCHIVES) $(MODULE_LDFLAGS) $(LIBGCC) $(LC_REQ) $(LIBGCC) >&2 ;\
	  exit 1; \
	fi

$(OBJS) : $(MODULE_BASE)/dynamic_module_makefile


# FIXME: Is the following code correct?
install: $(MODULE_INSTALL)
	$(TMP_BINDIR)/install_module module.so @prefix@/lib/pike/modules/$(MODNAME).so

