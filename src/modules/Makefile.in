@SET_MAKE@

MODULES=@subdirs@
MODULE_SEGMENTS=@MODULE_SEGMENTS@
MODULE_LINKOPTS=@MODULE_LINKOPTS@

MAKE_FLAGS = "prefix=$(prefix)" "exec_prefix=$(exec_prefix)" "CC=$(CC)" "OTHERFLAGS=$(OTHERFLAGS)" "TMP_BINDIR=$(TMP_BINDIR)" "TMP_LIBDIR=$(TMP_LIBDIR)" "RUNPIKE=$(RUNPIKE)" "DEFINES=$(DEFINES)" "INSTALL=$(INSTALL)"

all: modules

modules:
	for a in $(MODULES) ; do echo making $$a ; ( cd $$a ; $(MAKE) $(MAKE_FLAGS) MODNAME=$$a) ; done
	$(MAKE) linker_options lib_dirs modlist.h modlist_headers.h

modlist.h: $(MODULE_SEGMENTS)
	( for a in $(MODULES) ; do cat $$a/modlist_segment ; done ; ) >modlist.h

modlist_headers.h: $(MODULE_SEGMENTS)
	( for a in $(MODULES) ; do cat $$a/modlist_segment; done ) | sed -e 's/^.*{.*,\(.*\),\(.*\).*}.*$$/void \1(void),\2(void);/' >modlist_headers.h

linker_options: $(MODULE_LINKOPTS)
	( for a in $(MODULES) ; do cat $$a/linker_options ; done ; ) >linker_options

lib_dirs: $(MODULE_LINKOPTS)
	( ( if test -f master_lib_dirs; then cat master_lib_dirs; else :; fi; \
            for a in $(MODULES) ; do \
	      if test -f $$a/lib_dirs ; then cat $$a/lib_dirs ; else : ; fi ; \
	    done ; ) | sort | uniq | tr '\012' ':'; echo "" )| \
	sed -e 's/:$$//' -e 's/^/-R/' -e 's/^-R$$//' >lib_dirs

depend:
	for a in $(MODULES) ; do ( cd $$a ; ${MAKE} $(MAKE_FLAGS) MODNAME=$$a depend ) ; done

install:
	for a in $(MODULES) ; do ( cd $$a ; ${MAKE} $(MAKE_FLAGS) MODNAME=$$a install ) ; done

clean:
	for a in $(MODULES) ; do ( cd $$a ; ${MAKE} $(MAKE_FLAGS) MODNAME=$$a clean ) ; done

verify:
	for a in $(MODULES) ; do ( cd $$a ; echo verifying $$a ; ${MAKE} $(MAKE_FLAGS) MODNAME=$$a verify ) ; done

verbose_verify:
	for a in $(MODULES) ; do ( cd $$a ; ${MAKE} $(MAKE_FLAGS) MODNAME=$$a verbose_verify ) ; done

@dependencies@
