#
# $Id: static_module_makefile.in,v 1.97 2004/04/17 15:18:52 marcus Exp $
#


UNIQUE_MODNAME=$(MODNAME)

LINKAGE_CPPFLAGS=-Dpike_module_init=pike_module_$(UNIQUE_MODNAME)_init -Dpike_module_exit=pike_module_$(UNIQUE_MODNAME)_exit
LINKAGE_CFLAGS=

MODULE_PROGRAM=`echo $(MODDIR)|sed -e s:/:.:`$(MODULE_WRAPPER_PREFIX)$(MODNAME)
MODULE_TARGET=module.a

@common_module_makefile@

linker_options: Makefile $(MODULE_ARCHIVES)
	echo >linker_options `pwd`/module.a $(MODULE_LDFLAGS)
	@for a in '' $(MODULE_ARCHIVES) ; do \
	  if test "x$$a" = "x"; then :; else \
	    case "$$a" in \
	      /*) \
		echo $$a \
	      ;; \
	      *) \
		echo `pwd`/$$a \
	      ;; \
            esac >>linker_options; \
	  fi; \
	done

modlist_headers: Makefile
	@echo >modlist_headers "void pike_module_$(UNIQUE_MODNAME)_init(void), pike_module_$(UNIQUE_MODNAME)_exit(void);"

modlist_segment: Makefile
	@echo >modlist_segment " ,{ \"$(MODDIR)$(MODULE_WRAPPER_PREFIX)$(MODNAME)\", pike_module_$(UNIQUE_MODNAME)_init, pike_module_$(UNIQUE_MODNAME)_exit } "


# Can't depend on $(SRC_DIR)/$(CONFIG_HEADERS).in since
# $(CONFIG_HEADERS) isn't always used.
Makefile: $(MODULE_BASE)/static_module_makefile $(SRCDIR)/Makefile.in $(SRCDIR)/dependencies make_variables config.status
	CONFIG_FILES=Makefile CONFIG_HEADERS="$(CONFIG_HEADERS)" ./config.status
	touch remake
	@echo "Run make again" >&2
	@exit 1

module.a: $(OBJS)
	-rm -f module.a
	$(AR) cq module.a $(OBJS)
	-@RANLIB@ module.a
	if test -f linker_options ; then touch linker_options ; else :; fi

$(OBJS) : $(MODULE_BASE)/dynamic_module_makefile

install: $(MODULE_INSTALL)

